// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/*
ここから下にモデルを追加していく

サンプル　ユーザーモデル
*/
model users {
  u_id              String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  nickname          String?
  avatar_url        String?
  rank              Int?
  role              String?             @default("user")
  level_diagnosed   Boolean?            @default(false)
  created_at        DateTime?           @default(now()) @db.Timestamp(6)
  updated_at        DateTime?           @updatedAt      @db.Timestamptz(6)
  evaluations       evaluations[]
  skill_evaluations skill_evaluations[]
  step_photos       step_photos[]
  submissions       submissions[]
  user_skills       user_skills[]
}

model skills {
  sk_id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String              @unique
  description       String?
  image_url         String?
  tags              Json?
  recipe_skills     recipe_skills[]
  recipe_steps      recipe_steps[]
  skill_evaluations skill_evaluations[]
  skill_tags        skill_tags[]
  user_skills       user_skills[]
}

model user_skills {
  us_id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  u_id         String    @db.Uuid
  sk_id        String    @db.Uuid
  level        Int       @default(1)
  passed_count Int       @default(0)
  acquired_at  DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @updatedAt      @db.Timestamptz(6)
  skill        skills    @relation(fields: [sk_id], references: [sk_id], onDelete: Cascade, onUpdate: NoAction)
  user         users     @relation(fields: [u_id], references: [u_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([u_id, sk_id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model evaluations {
  e_id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  s_id         String      @db.Uuid
  u_id         String      @db.Uuid
  is_passed    Boolean?
  advice       String?
  evaluated_at DateTime?   @default(now()) @db.Timestamp(6)
  submissions  submissions @relation(fields: [s_id], references: [s_id], onDelete: Cascade, onUpdate: NoAction)
  users        users       @relation(fields: [u_id], references: [u_id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model recipe_ingredients {
  ing_id      String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  r_id        String  @db.Uuid
  name        String
  quantity    String?
  unit        String?
  order_index Int?
  note        String?
  recipes     recipes @relation(fields: [r_id], references: [r_id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model recipe_skills {
  r_id    String  @db.Uuid
  sk_id   String  @db.Uuid
  recipes recipes @relation(fields: [r_id], references: [r_id], onDelete: Cascade, onUpdate: NoAction)
  skills  skills  @relation(fields: [sk_id], references: [sk_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([r_id, sk_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model recipe_step_images {
  image_id     String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  step_id      String       @db.Uuid
  image_url    String
  order_index  Int?         @default(1)
  recipe_steps recipe_steps @relation(fields: [step_id], references: [step_id], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model recipe_steps {
  step_id                String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  r_id                   String                   @db.Uuid
  step_number            Int
  instruction            String
  sk_id                  String?                  @db.Uuid
  requires_photo         Boolean?                 @default(false)
  title                  String?
  recipe_step_images     recipe_step_images[]
  recipes                recipes                  @relation(fields: [r_id], references: [r_id], onDelete: Cascade, onUpdate: NoAction)
  skills                 skills?                  @relation(fields: [sk_id], references: [sk_id], onDelete: NoAction, onUpdate: NoAction)
  step_photos            step_photos[]
  submission_step_images submission_step_images[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model recipes {
  r_id               String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title              String
  description        String?
  difficulty         Int
  finish_url         String?
  recipe_ingredients recipe_ingredients[]
  recipe_skills      recipe_skills[]
  recipe_steps       recipe_steps[]
  submissions        submissions[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model skill_evaluations {
  se_id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  s_id         String      @db.Uuid
  sk_id        String      @db.Uuid
  u_id         String      @db.Uuid
  is_passed    Boolean
  evaluated_at DateTime    @default(now()) @db.Timestamp(6)
  submissions  submissions @relation(fields: [s_id], references: [s_id], onDelete: Cascade, onUpdate: NoAction)
  skills       skills      @relation(fields: [sk_id], references: [sk_id], onDelete: Cascade, onUpdate: NoAction)
  users        users       @relation(fields: [u_id], references: [u_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([s_id, sk_id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model skill_tags {
  sk_id  String @db.Uuid
  tag    String
  skills skills @relation(fields: [sk_id], references: [sk_id], onDelete: Cascade, onUpdate: NoAction)

  @@id([sk_id, tag])
}

model step_photos {
  photo_id     String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  step_id      String       @db.Uuid
  u_id         String       @db.Uuid
  image_url    String
  uploaded_at  DateTime?    @default(now()) @db.Timestamp(6)
  recipe_steps recipe_steps @relation(fields: [step_id], references: [step_id], onDelete: Cascade, onUpdate: NoAction)
  users        users        @relation(fields: [u_id], references: [u_id], onDelete: Cascade, onUpdate: NoAction)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model submission_step_images {
  ssi_id       String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  s_id         String       @db.Uuid
  step_id      String       @db.Uuid
  image_url    String
  submissions  submissions  @relation(fields: [s_id], references: [s_id], onDelete: Cascade, onUpdate: NoAction)
  recipe_steps recipe_steps @relation(fields: [step_id], references: [step_id], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model submissions {
  s_id                   String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  u_id                   String                   @db.Uuid
  r_id                   String                   @db.Uuid
  image_urls             String[]
  submitted_at           DateTime                 @default(now()) @db.Timestamp(6)
  status                 String
  feedback               String?
  evaluations            evaluations[]
  skill_evaluations      skill_evaluations[]
  submission_step_images submission_step_images[]
  recipes                recipes                  @relation(fields: [r_id], references: [r_id], onDelete: Cascade, onUpdate: NoAction)
  users                  users                    @relation(fields: [u_id], references: [u_id], onDelete: Cascade, onUpdate: NoAction)
}
